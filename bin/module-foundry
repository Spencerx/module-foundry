#!/usr/bin/env node
//
// Module Foundary
//
// BuildBot for Node
//
// sudo PORT=${PORT:=80} node module-foundry
// tar -cz -C example/http-app/ . | curl -o out.tgz -H content-type:application/tar+gzip --data-binary @- localhost:${PORT:=80} -v
//
// TODO
// - module cache
// - more error checks
//
var flatiron = require('flatiron');
var Understudy = require('understudy').Understudy;

var os = require('os');
var app = Understudy.call(flatiron.app);
app.config.argv().file('config.json').env().defaults({
   directories: {
      tmp: __dirname + '/../tmp'
   },
   node: {
    gypdir: process.env.HOME + '/.node-gyp',
    versions: [process.version.slice(1)]
   },
   spawning: {
    platform: os.platform(),
    arch: os.arch(),
    env: {
      npm_config_production: 'true'
    },
    user: 'nobody',
    group: 'nobody'
   },
   defaults: {
     build: {
       version: '0.8.x'
     }
   }
});
//
// Monitor and Repository support
//
app.use(require('../lib/plugins/pluggable'));
app.use(require('../lib/plugins/servers'));
app.use(require('../lib/plugins/http'));
require('../lib/routes')(app, app.config.get('routes'));
app.init();
